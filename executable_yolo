#!/bin/bash

# YOLO - Run AI coding agents with appropriate bypass flags
# Portable replacement for the Elvish yolo function
# Supports automatic worktree creation and per-agent flag mapping

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to print colored output
print_color() {
    local color=$1
    shift
    printf "${color}%s${NC}\n" "$*" >&2
}

# Function to get flags for a command (with environment override support)
get_flags_for_command() {
    local cmd="$1"
    local env_var="YOLO_FLAGS_$(echo "$cmd" | tr '[:lower:]' '[:upper:]')"  # Convert to uppercase for env var name
    local default_flags=""

    # Set default flags based on command
    case "$cmd" in
        codex)
            default_flags="--dangerously-bypass-approvals-and-sandbox"
            ;;
        claude)
            default_flags="--dangerously-skip-permissions"
            ;;
        copilot)
            default_flags="--allow-all-tools --allow-all-paths"
            ;;
        droid)
            default_flags="--skip-permissions-unsafe"
            ;;
        amp)
            default_flags="--dangerously-allow-all"
            ;;
        cursor-agent)
            default_flags="--force"
            ;;
        opencode)
            default_flags=""
            ;;
        *)
            default_flags="--yolo"
            ;;
    esac

    # Check for environment override
    if [ -n "${!env_var:-}" ]; then
        echo "${!env_var}"
    else
        echo "$default_flags"
    fi
}

# Function to show usage
show_usage() {
    cat >&2 <<EOF
YOLO - Run AI coding agents with appropriate bypass flags

Usage: yolo [OPTIONS] COMMAND [ARGS...]

Options:
  -w, --worktree    Create a git worktree before running the command
  -h, --help        Show this help message
  -v, --version     Show version information
  --dry-run         Show what would be executed without running it

Supported Commands:
  codex             Anthropic Code (adds --dangerously-bypass-approvals-and-sandbox)
  claude            Claude Code (adds --dangerously-skip-permissions)
  copilot           GitHub Copilot (adds --allow-all-tools --allow-all-paths)
  droid             Factory AI Droid (adds --skip-permissions-unsafe)
  amp               Sourcegraph Amp (adds --dangerously-allow-all)
  cursor-agent      Cursor Agent (adds --force)
  opencode          OpenCode (no additional flags)
  <other>           Any other command (adds --yolo)

Examples:
  yolo claude "Fix the bug in src/main.js"
  yolo -w droid "Refactor the authentication module"
  yolo codex --help

EOF
}

# Parse options
use_worktree=false
dry_run=false
while [[ $# -gt 0 ]]; do
    case $1 in
        -w|--worktree)
            use_worktree=true
            shift
            ;;
        -h|--help)
            show_usage
            exit 0
            ;;
        -v|--version)
            echo "YOLO version 1.0.0"
            exit 0
            ;;
        --dry-run)
            dry_run=true
            shift
            ;;
        -*)
            print_color "$RED" "Unknown option: $1"
            show_usage
            exit 1
            ;;
        *)
            # First non-option argument is the command
            break
            ;;
    esac
done

# Check if command is provided
if [ $# -eq 0 ]; then
    print_color "$RED" "Error: missing command argument"
    show_usage
    exit 1
fi

cmd="$1"
shift
rest_args=("$@")

# If worktree mode is enabled, set up the worktree
if [ "$use_worktree" = true ]; then
    # Check if we're in a git repository
    if ! git rev-parse --git-dir >/dev/null 2>&1; then
        print_color "$RED" "Error: not in a git repository, cannot create worktree"
        exit 1
    fi

    # Create .conductor directory in repo root if it doesn't exist
    repo_root=$(git rev-parse --show-toplevel)
    conductor_dir="$repo_root/.conductor"
    if [ ! -d "$conductor_dir" ]; then
        mkdir -p "$conductor_dir"
    fi

    # Generate branch name based on agent and timestamp
    timestamp=$(date +%Y%m%d-%H%M%S)
    branch_name="yolo/$cmd/$timestamp"
    worktree_path="$conductor_dir/$cmd-$timestamp"

    print_color "$BLUE" "Creating worktree at $worktree_path with branch $branch_name"

    # Create the worktree
    if ! git worktree add -b "$branch_name" "$worktree_path" 2>&1; then
        print_color "$RED" "Error: failed to create worktree"
        exit 1
    fi

    print_color "$BLUE" "Switching to worktree..."
    cd "$worktree_path" || exit 1
fi

# Handle dry-run mode
if [ "$dry_run" = true ]; then
    flags=$(get_flags_for_command "$cmd")
    print_color "$BLUE" "DRY RUN: Would execute in $(pwd):"
    if [ -n "$flags" ]; then
        print_color "$YELLOW" "$cmd $flags ${rest_args[*]}"
    else
        print_color "$YELLOW" "$cmd ${rest_args[*]}"
    fi
    exit 0
fi

# Map commands to their appropriate bypass flags
flags=$(get_flags_for_command "$cmd")
if [ -n "$flags" ]; then
    print_color "$GREEN" "Running $cmd with $flags"
    exec "$cmd" $flags "${rest_args[@]}"
else
    if ! command -v "$cmd" >/dev/null 2>&1; then
        print_color "$RED" "Error: command '$cmd' not found"
        exit 1
    fi
    print_color "$GREEN" "Running $cmd"
    exec "$cmd" "${rest_args[@]}"
fi
